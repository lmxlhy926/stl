# 文件I/O

## 引言

UNIX系统中的大多数文件I/O只需用到5个函数：`open`, `read`, `write`, `lseek`, `close`。

本章描述的函数经常被称为**`不带缓冲的I/O`**，与**`标准I/O函数`**相对照。术语不带缓冲指的是每个`read`, `write` 都调用内核中的一个系统调用。

只要涉及在多个`进程间共享资源`，原子操作的概念就变的非常重要。本章将进一步讨论在多个进程间如何共享文件，以及所涉及的内核有关数据结构。在描述了这些特征后，将说明`dup`	`fcntl`	 `sync`	`fsync`	`ioctl`函数。

## 文件描述符

**对于内核而言，所有打开的文件都通过文件描述符引用**。文件描述符是一个非负整数。当打开一个现有文件或创建一个新文件时，**内核向进程返回一个文件描述符**。按照惯例，UNIX系统shell把文件描述符0与进程的标准输入关联，文件描述符1与进程的标准输出关联，文件描述2与进程的标准错误关联。在符合POSIX.1的应用程序中，幻数0、1、2虽然已被标准化，但应当把他们替换成符号常量**STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO**以提高可读性。

## open

```c
#include <fcntl.h>
int open(const char* path, int oflag, .../*mode_t mode*/)
					
参数说明：
    path：要打开或创建文件的名字，用绝对路径来指示。
    oflag：一个或多个常量进行"或"运算构成oflag参数。
    mode：仅当创建新文件时才使用这个参数，指明创建的文件的访问权限位
返回值：
	若成功返回文件描述符，若错误返回-1.
```

由open和openat函数返回的文件描述符一定是最小的未用描述符数值。

## close

```c
#include <unistd.h>
int close(int fd);
返回值：
    若成功返回0，若失败返回-1
```

关闭一个文件时还会释放该进程加在该文件上的所有记录锁。

当一个进程终止时，内核自动关闭它所有的打开文件。

## lseek

```c
#include <unistd.h>
off_t lseek(int fd, off_t offset, int whence)
    
whence取值:
    SEEK_SET：绝对偏移量
    SEEK_CUR：相对于当前位置的偏移量
    SEEK_END：相对文件尾端的偏移量
返回值：
    成功返回新的文件偏移量，出错返回-1
```

**每个打开文件都有一个与其相关联的"当前文件偏移量"**。它通常是一个非负整数，用来度量从文件开始处计算的字节数。**通常，读、写操作都从当前文件偏移量处开始，并使偏移量增加所读写的字节数**。对于普通文件，其偏移量必须是非负值。因为偏移量可能是负值，所以在比较lseek的返回值时需要谨慎，不要测试它是否小于0，而要测试它是否等于-1.

文件偏移量可以大于文件的当前长度，在这种情况下，对该文件的下一次写将加长该文件，并在文件中构成一个空洞，这一点是允许的。**位于文件中但是没有写过的字节都被读为0**。文件中的空洞并不要求在磁盘上占用存储区，具体处理方式和文件系统的实现有关。

因为lseek使用的偏移量是用off_t类型表示的，所以允许具体实现根据各自特定的平台自行选择大小合适的数据类型。现今大多数平台提供2组接口以处理文件偏移量。一组使用32位文件偏移量，另一组使用64位文件偏移量。尽管可以实现64位文件偏移量，但是能否创建一个大于2GB的文件则依赖于底层文件系统的类型。

## read

```c
#include <unistd.h>
ssize_t read(int fd, void *buf, size_t nbytes);
返回值：
    读到的字节数，若已到文件尾端，返回0；若出错，返回-1
```

有多种情况可使实际读到的字节数小于要求读的字节数：

​		**读普通文件：**在读到要求字节数之前已经到达了文件尾端

​		**读终端设备：**通常一次最多读一行

​		**读网络：**网络中缓冲机制可能造成返回值小于所要求读的字节数

​		**读管道或FIFO：**管道包含的字节数小于所需的数量，返回实际可用的字节数

​		**读面向记录的设备：**如磁带，一次最多返回一个记录

​		**信号中断：**信号造成中断，而已经读取了部分数据量

## write

```c
#include <unistd.h>
ssize_t write(int fd, const void *buf, size_t nbytes);
返回值：
    若成功返回已写的字节数；若出错，返回-1
```

write出错的一个常见原因是磁盘已写满，或者超过了一个给定进程的文件长度限制。

对于普通文件，写操作从文件的当前偏移量处开始。如果在打开该文件时，指定了O_APPEND选项，则在每次写操作之前，将文件偏移量设置在文件的当前结尾处。在一次成功写之后，该文件偏移量增加实际写的字节数。





























































