# 文件I/O

## 引言

UNIX系统中的大多数文件I/O只需用到5个函数：`open`, `read`, `write`, `lseek`, `close`。

本章描述的函数经常被称为**`不带缓冲的I/O`**，与**`标准I/O函数`**相对照。术语不带缓冲指的是每个`read`, `write` 都调用内核中的一个系统调用。

只要涉及在多个`进程间共享资源`，原子操作的概念就变的非常重要。本章将进一步讨论在多个进程间如何共享文件，以及所涉及的内核有关数据结构。在描述了这些特征后，将说明`dup`	`fcntl`	 `sync`	`fsync`	`ioctl`函数。

## 文件描述符

对于内核而言，所有打开的文件都通过文件描述符引用。文件描述符是一个非负整数。当打开一个现有文件或创建一个新文件时，**内核向进程返回一个文件描述符**。按照惯例，UNIX系统shell把文件描述符0与进程的标准输入关联，文件描述符1与进程的标准输出关联，文件描述2与进程的标准错误关联。在符合POSIX.1的应用程序中，幻数0、1、2虽然已被标准化，但应当把他们替换成符号常量STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO以提高可读性。

## open

```c
#include <fcntl.h>
int open(const char* path, int oflag, .../*mode_t mode*/)
					
参数说明：
    path：要打开或创建文件的名字，用绝对路径来指示。
    oflag：一个或多个常量进行"或"运算构成oflag参数。
    mode：仅当创建新文件时才使用这个参数，指明创建的文件的权限
返回值：
	若成功返回文件描述符，若错误返回-1.
```

由open和openat函数返回的文件描述符一定是最小的未用描述符数值。

## close

```c
#include <unistd.h>
int close(int fd);
返回值：
    若成功返回0，若失败返回-1
```

关闭一个文件时还会释放该进程加在该文件上的所有记录锁。

当一个进程终止时，内核自动关闭它所有的打开文件。

## lseek

```c
#include <unistd.h>
off_t lseek(int fd, off_t offset, int whence)
    
whence取值:
    SEEK_SET：绝对偏移量
    SEEK_CUR：相对于当前位置的偏移量
    SEEK_END：相对文件尾端的偏移量
返回值：
    成功返回新的文件偏移量，出错返回-1
```

每个打开文件都有一个与其相关联的"当前文件偏移量"。它通常是一个非负整数，用来度量从文件开始处计算的字节数。**通常，读、写操作都从当前文件偏移量处开始，并使偏移量增加所读写的字节数**。

























